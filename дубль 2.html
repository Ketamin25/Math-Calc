<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Å—á—ë—Ç ‚Äî —É—Ä–æ–≤–Ω–∏, XP –∏ —Ç—Ä–µ–Ω–∞–∂—ë—Ä</title>
<meta name="description" content="–¢—Ä–µ–Ω–∞–∂—ë—Ä —É—Å—Ç–Ω–æ–≥–æ —Å—á—ë—Ç–∞ —Å —É—Ä–æ–≤–Ω—è–º–∏, –æ–ø—ã—Ç–æ–º, —Å–µ—Ä–∏—è–º–∏, —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π 2√ó2, —Å–º–µ—à–∞–Ω–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π. –°–ª–æ–∂–µ–Ω–∏–µ, –≤—ã—á–∏—Ç–∞–Ω–∏–µ, —É–º–Ω–æ–∂–µ–Ω–∏–µ, –¥–µ–ª–µ–Ω–∏–µ.">
<style>
  :root{
    --bg:#0f172a; --card:#ffffff; --muted:#64748b; --border:#e2e8f0; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --warn:#f59e0b;
    --radius:16px; --shadow:0 12px 40px rgba(2,6,23,.18);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#0b1220; display:grid; place-items:start center; padding:24px}
  .app{width:100%; max-width:1220px; display:grid; gap:16px}

  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
  .panel{padding:18px 18px 10px}
  .quiz{padding:20px; display:grid; gap:14px}

  .row{display:grid; gap:12px}
  @media (min-width:980px){
    .row{grid-template-columns: 1.6fr 1fr;} /* —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —à–∏—Ä–µ –∏ –ø–µ—Ä–≤–∞—è */
  }

  /* –®–∞–ø–∫–∞ —É—Ä–æ–≤–Ω–µ–π */
  .level-header{display:flex; gap:16px; align-items:center; padding:16px 18px; background:linear-gradient(135deg,#1d4ed8,#06b6d4); color:#fff; border-radius:var(--radius)}
  .avatar{width:72px; height:72px; border-radius:999px; background:#0ea5e9; display:grid; place-items:center; font-weight:800; font-size:28px; box-shadow:inset 0 0 0 4px rgba(255,255,255,.25); overflow:hidden}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .level-meta{flex:1; display:grid; gap:6px}
  .level-top{display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px}
  .level-top .rank{font-size:14px; opacity:.9}
  .level-top .lvl{font-size:20px; font-weight:700}
  .level-bar{position:relative; height:12px; background:rgba(255,255,255,.35); border-radius:999px; overflow:hidden}
  .level-bar > i{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,#a78bfa,#22c55e)}
  .level-note{font-size:13px; opacity:.95}

  /* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞) */
  .task{font-size:34px; letter-spacing:.3px; text-align:center}
  .stats{display:flex; gap:12px; flex-wrap:wrap; font-size:14px; color:#334155}
  .stat{padding:10px 12px; background:#f1f5f9; border:1px solid var(--border); border-radius:12px}
  .answer-block{display:grid; gap:8px}
  label{font-size:13px; color:#334155; display:block; margin-bottom:4px}
  select, input[type="number"], input[type="text"], button, .toggle{width:100%}
  select, input[type="number"], input[type="text"]{padding:10px 12px; font-size:16px; border:1px solid var(--border); border-radius:12px; outline:none}
  select:focus, input:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(37,99,235,.15)}
  .toggle{display:flex; gap:8px; flex-wrap:wrap}
  .toggle button{flex:1}
  .btn{padding:12px 14px; font-size:16px; border-radius:12px; border:1px solid var(--border); background:#f8fafc; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
  .btn.ghost{background:#fff}
  .btn.warn{background:var(--warn); color:#111827; border-color:transparent}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .feedback{min-height:26px; font-size:15px}
  .feedback.good{color:var(--good)}
  .feedback.bad{color:var(--bad)}
  .divider{height:1px; background:var(--border); margin:6px 0}
  .flex{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .timerbig{font-variant-numeric:tabular-nums; font-size:22px; font-weight:700; color:#0f172a; background:#f1f5f9; border:1px solid var(--border); border-radius:12px; padding:8px 12px; text-align:center}
  .timerbar{position:relative; height:10px; background:#e2e8f0; border-radius:999px; overflow:hidden}
  .timerbar > i{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#16a34a,#22c55e);}
  .subrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  /* –õ–µ–≤–∞—è —á–∞—Å—Ç—å (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏) */
  .controls{display:grid; gap:12px}
  details{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:12px}
  summary{cursor:pointer}
  .hint{font-size:13px; color:#64748b}
  table{width:100%; border-collapse:collapse}
  th,td{border-top:1px solid var(--border); padding:8px 10px; text-align:left; font-size:14px}
  th{background:#f8fafc}
  .nowrap{white-space:nowrap}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<div class="app">

  <!-- –®–∞–ø–∫–∞ —É—Ä–æ–≤–Ω–µ–π -->
  <section class="card level-header" id="hdr">
    <div class="avatar" id="avatar">E</div>
    <div class="level-meta">
      <div class="level-top">
        <div class="lvl">–£—Ä–æ–≤–µ–Ω—å <span id="lvl">1</span> <span class="rank" id="rank">‚Ä¢ –£—á–µ–Ω–∏–∫</span></div>
        <div class="level-note">XP: <b id="xp">0</b> ‚Ä¢ –í —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ: <b id="inlevel">0</b>/<b id="span">100</b> <span id="xpgain" style="margin-left:8px"></span> <span id="helloUser"></span></div>
      </div>
      <div class="level-bar"><i id="lvlbar"></i></div>
    </div>
  </section>

  <div class="row">
    <!-- –ü—Ä–∞–≤–∞—è (–æ—Å–Ω–æ–≤–Ω–∞—è) -->
    <section class="card quiz" aria-live="polite">
      <!-- –í–µ—Ä—Ö–Ω–∏–π —Ç–∞–π–º–µ—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div class="flex" style="gap:10px; align-items:flex-end">
        <div class="subrow" style="flex:1">
          <div class="timerbig" id="timerDigits" title="–û—Å—Ç–∞–ª–æ—Å—å">00:00</div>
          <div class="timerbig" id="elapsedDigits" title="–ü—Ä–æ—à–ª–æ">00:00</div>
          <div style="min-width:120px">
            <label for="timelimit" style="margin-bottom:2px">–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
            <input id="timelimit" type="number" min="0" step="5" value="60" placeholder="0 = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞">
          </div>
          <div class="timerbig" title="–û—Å—Ç–∞–ª–æ—Å—å —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö 2√ó2">2√ó2: <span id="baseLeftBig">‚Äî</span></div>
        </div>
        <div class="flex" style="gap:8px">
          <button class="btn primary" id="start">–°—Ç–∞—Ä—Ç</button>
          <button class="btn" id="pause">–ü–∞—É–∑–∞</button>
          <button class="btn" id="stop">–°—Ç–æ–ø</button>
          <button class="btn" id="next" title="–ü—Ä–æ–±–µ–ª / Ctrl+Enter">–°–ª–µ–¥—É—é—â–∞—è</button>
        </div>
      </div>
      <div class="timerbar" aria-hidden="true"><i id="bar"></i></div>

      <div class="stats">
        <div class="stat">–°–µ—Ä–∏—è: <b id="streak">0</b></div>
        <div class="stat">–õ—É—á—à–∞—è: <b id="best">0</b></div>
        <div class="stat">–í—Å–µ–≥–æ: <b id="total">0</b></div>
        <div class="stat">–í–µ—Ä–Ω—ã—Ö: <b id="correct">0</b></div>
        <div class="stat">–¢–æ—á–Ω–æ—Å—Ç—å: <b id="acc">0%</b></div>
        <div class="stat nowrap">‚åÄ —Å–µ–∫/–∑–∞–¥: <b id="avg">0.0</b></div>
        <div class="stat nowrap">–ü–æ—Å–ª–µ–¥–Ω–µ–µ: <b id="lastTime">‚Äî</b></div>
        <div class="stat" style="min-width:160px">–û—Å—Ç–∞–ª–æ—Å—å: <b id="timeleft">‚Äî</b></div>
      </div>

      <div class="task mono" id="task">–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</div>

      <div class="answer-block">
        <label for="answer">–û—Ç–≤–µ—Ç:</label>
        <input id="answer" type="number" inputmode="decimal" placeholder="–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç" />
        <button class="btn primary" id="check" title="Enter">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>

      <div class="feedback" id="feedback"></div>

      <details id="work" open>
        <summary>–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ä–∞–∑–±–æ—Ä –¥–ª—è —Å—á—ë—Ç–∞ –≤ —É–º–µ</summary>
        <div id="explain" class="hint">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä: —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –ø–æ –¥–µ—Å—è—Ç–∫–∞–º/–µ–¥–∏–Ω–∏—Ü–∞–º, —É–¥–æ–±–Ω—ã–µ –ø–∞—Ä—ã, –¥–µ–ª–µ–Ω–∏–µ —Å —Ü–µ–ª—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏ —Ç.–¥.</div>
      </details>
    </section>

    <!-- –õ–µ–≤–∞—è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + –£–¢–ò–õ–ò–¢–´ –ü–ï–†–ï–ù–ï–°–ï–ù–´ –°–Æ–î–ê) -->
    <section class="card panel">
      <div class="controls">
        <!-- Google Sign-In -->
        <div id="authBox">
          <div id="g_id_onload"
               data-client_id="YOUR_GOOGLE_CLIENT_ID"
               data-context="signin"
               data-callback="onGoogleSignIn"
               data-auto_prompt="false"></div>
          <div class="g_id_signin"
               data-type="standard"
               data-shape="rectangular"
               data-theme="outline"
               data-text="signin_with"
               data-size="large"
               data-logo_alignment="left"></div>
          <div id="signed" style="display:none; font-size:14px; color:#334155; margin-top:6px">
            –í–æ—à—ë–ª –∫–∞–∫ <b id="who"></b>. <button class="btn" id="signout" style="margin-top:6px">–í—ã–π—Ç–∏</button>
          </div>
        </div>

        <div class="toggle" role="group" aria-label="–†–µ–∂–∏–º">
          <button class="btn ghost" data-mode="add" id="mode-add">–°–ª–æ–∂–µ–Ω–∏–µ</button>
          <button class="btn ghost" data-mode="sub" id="mode-sub">–í—ã—á–∏—Ç–∞–Ω–∏–µ</button>
          <button class="btn ghost" data-mode="mul" id="mode-mul">–£–º–Ω–æ–∂–µ–Ω–∏–µ</button>
          <button class="btn ghost" data-mode="div" id="mode-div">–î–µ–ª–µ–Ω–∏–µ</button>
          <button class="btn ghost" data-mode="mix" id="mode-mix">–°–º–µ—à–∞–Ω–Ω—ã–π</button>
          <button class="btn ghost" data-mode="custom" id="mode-custom">–°–≤–æ—è –∑–∞–¥–∞—á–∞</button>
        </div>

        <div id="custom-box" style="display:none">
          <label>–°–≤–æ—è –∑–∞–¥–∞—á–∞</label>
          <div class="flex" style="gap:8px">
            <input id="c-a" type="number" placeholder="23" style="max-width:130px">
            <select id="c-op1" style="max-width:120px">
              <option value="+">+</option><option value="-">‚àí</option><option value="*">√ó</option><option value="/">√∑</option>
            </select>
            <input id="c-b" type="number" placeholder="45" style="max-width:130px">
            <select id="c-op2" style="max-width:120px">
              <option value="none">‚Äî</option><option value="+">+</option><option value="-">‚àí</option><option value="*">√ó</option><option value="/">√∑</option>
            </select>
            <input id="c-c" type="number" placeholder="55" style="max-width:130px">
          </div>
          <div class="flex" style="gap:8px; margin-top:8px">
            <input id="c-result" type="number" inputmode="decimal" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="max-width:220px">
            <button class="btn" id="c-use">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div>
          <label for="level">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</label>
          <select id="level">
            <option value="easy">–õ—ë–≥–∫–∏–π ‚Äî 2√ó2 –∏ 2¬±2</option>
            <option value="medium">–°—Ä–µ–¥–Ω–∏–π ‚Äî 3√ó2 –∏ 3¬±2</option>
            <option value="hard">–°–ª–æ–∂–Ω—ã–π ‚Äî 3√ó3 –∏ —Ç—Ä–æ–π–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ</option>
          </select>
        </div>

        <div id="mix-ops" style="display:none">
          <label>–ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–∞—Ç—å –≤ ¬´–°–º–µ—à–∞–Ω–Ω—ã–π¬ª</label>
          <div class="flex" style="gap:8px">
            <label><input type="checkbox" id="m-add" checked> –°–ª–æ–∂–µ–Ω–∏–µ</label>
            <label><input type="checkbox" id="m-sub" checked> –í—ã—á–∏—Ç–∞–Ω–∏–µ</label>
            <label><input type="checkbox" id="m-mul" checked> –£–º–Ω–æ–∂–µ–Ω–∏–µ</label>
            <label><input type="checkbox" id="m-div" checked> –î–µ–ª–µ–Ω–∏–µ</label>
          </div>
        </div>

        <div>
          <label>–ë–∞–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö 2√ó2</label>
          <div class="flex">
            <button class="btn" id="useBase">–¢—Ä–µ–Ω–∞–∂—ë—Ä 2√ó2 (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ)</button>
            <button class="btn" id="resetBase">–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É</button>
          </div>
          <div class="hint">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤ –¥–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è: <span id="baseLeft">‚Äî</span> –æ—Å—Ç–∞–ª–æ—Å—å.</div>
        </div>

        <!-- –£—Ç–∏–ª–∏—Ç—ã (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ –ø—Ä–∞–≤–æ–≥–æ –±–ª–æ–∫–∞) -->
        <details open>
          <summary>–£—Ç–∏–ª–∏—Ç—ã</summary>
          <div class="controls" style="margin-top:6px">
            <button class="btn" id="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            <button class="btn" id="clear">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
            <button class="btn" id="exportCsv">–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ (CSV)</button>
            <button class="btn" id="clearHistory">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
          </div>
        </details>
      </div>
    </section>
  </div>

  <section class="card panel">
    <h3 style="margin:0 0 10px">–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–∏</h3>
    <div class="hint">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (LocalStorage). –°—Ç–æ–ª–±—Ü—ã: ‚Ññ, –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≤—Ä–µ–º—è (—Å), –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏, —Å–µ—Ä–∏—è.</div>
    <div style="overflow:auto">
      <table id="table">
        <thead>
          <tr><th>#</th><th>–í—ã—Ä–∞–∂–µ–Ω–∏–µ</th><th>–¢–≤–æ–π –æ—Ç–≤–µ—Ç</th><th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–í—Ä–µ–º—è (—Å)</th><th>–ö–æ–≥–¥–∞</th><th>–°–µ—Ä–∏—è</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const nowISO = () => new Date().toISOString();
  const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
  const fmt = n => Number(n).toFixed(1);
  const clamp0 = x => Math.max(0, x);
  const parseJwt = (t)=>{ try{ return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));}catch(e){return null;} };

  // ===== Levels / XP =====
  const LVL_MAX = 100;
  let thresholds = Array.from({length:LVL_MAX}, (_,i)=> Math.round(10000 * Math.pow(i/(LVL_MAX-1), 2)));

  function rankFor(lvl){
    if (lvl>=90) return {name:'–ì—Ä–∞–Ω–¥–º–∞—Å—Ç–µ—Ä', initial:'G'};
    if (lvl>=70) return {name:'–ì–µ–Ω–∏–π', initial:'üß†'};
    if (lvl>=50) return {name:'–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä', initial:'P'};
    if (lvl>=30) return {name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫', initial:'M'};
    if (lvl>=20) return {name:'–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', initial:'R'};
    if (lvl>=10) return {name:'–£—á—ë–Ω—ã–π', initial:'U'};
    return {name:'–£—á–µ–Ω–∏–∫', initial:'E'};
  }
  function setAvatar(lvl, profile){
    const box = $('#avatar');
    box.innerHTML = '';
    if (profile?.picture){
      const img = document.createElement('img'); img.src = profile.picture; box.appendChild(img);
    } else {
      const r = rankFor(lvl); box.textContent = r.initial;
    }
    $('#rank').textContent = '‚Ä¢ ' + rankFor(lvl).name;
  }

  // ===== State =====
  const state = {
    running:false,
    mode:'mul', level:'easy', third:'auto',
    allowedMix: {add:true, sub:true, mul:true, div:true},
    useBase:false,
    expr:null, result:null, hint:'',
    timerId:null, sessionStart:0, sessionEnd:0, sessionTotal:0,
    qStart:0, lastTime:null,
    streak:0, best:Number(localStorage.getItem('bestStreak')||0), total:0, correct:0,
    history: JSON.parse(localStorage.getItem('mm_history')||'[]'),
    base:{ left:0 },
    xp: Number(localStorage.getItem('mm_xp')||0),
    lvl: 1,
    lastGain: 0,
    user: JSON.parse(localStorage.getItem('mm_user')||'null')
  };

  function recalcLevel(){
    let l = 1;
    for (let i=0;i<thresholds.length;i++){
      if (state.xp >= thresholds[i]) l = i+1;
    }
    state.lvl = Math.min(l, LVL_MAX);
  }
  function updateLevelUI(){
    recalcLevel();
    const lvl = state.lvl;
    const currBase = thresholds[lvl-1];
    const nextBase = thresholds[Math.min(lvl, LVL_MAX-1)];
    const inLevel = clamp0(state.xp - currBase);
    const span = Math.max(1, nextBase - currBase);
    const pct = Math.min(100, Math.round(100 * inLevel / span));
    $('#lvl').textContent = lvl;
    $('#xp').textContent = Math.floor(state.xp);
    $('#inlevel').textContent = inLevel;
    $('#span').textContent = span;
    $('#lvlbar').style.width = pct + '%';
    if (state.lastGain!==0){
      const sign = state.lastGain>0 ? '+' : '';
      $('#xpgain').textContent = `(${sign}${state.lastGain.toFixed(2)} XP)`;
      $('#xpgain').style.color = state.lastGain>0 ? '#d1f7d6' : '#ffe1e1';
    } else {
      $('#xpgain').textContent = '';
    }
    localStorage.setItem('mm_xp', String(Math.max(0,state.xp)));
    setAvatar(lvl, state.user);
  }

  // ===== Google Sign-In =====
  window.onGoogleSignIn = (resp)=>{
    const prof = parseJwt(resp.credential);
    if (prof){ state.user = {name:prof.name, email:prof.email, picture:prof.picture}; }
    localStorage.setItem('mm_user', JSON.stringify(state.user||null));
    updateAuthUI();
    updateLevelUI();
  };
  function updateAuthUI(){
    if (state.user){
      $('#who').textContent = state.user.name || state.user.email || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      $('#signed').style.display = 'block';
    } else {
      $('#signed').style.display = 'none';
    }
    $('#helloUser').textContent = state.user ? `‚Ä¢ –ü—Ä–∏–≤–µ—Ç, ${state.user.name.split(' ')[0]}!` : '';
  }
  $('#signout')?.addEventListener('click', ()=>{
    state.user=null; localStorage.removeItem('mm_user'); updateAuthUI(); updateLevelUI();
  });

  // ===== Unique 2√ó2 base =====
  function buildBase(){
    const used = new Set(JSON.parse(localStorage.getItem('mm_base_used')||'[]'));
    state.base.left = 4095 - used.size;
    updateBaseLeft();
    return used;
  }
  let usedPairs = buildBase();
  function pairKey(a,b){ const [x,y]=a<=b?[a,b]:[b,a]; return `${x}x${y}`; }
  function pickUnique2x2(){
    if (usedPairs.size >= 4095) return null;
    while(true){
      const a=rand(10,99), b=rand(10,99);
      const key = pairKey(a,b);
      if(!usedPairs.has(key)){
        usedPairs.add(key);
        localStorage.setItem('mm_base_used', JSON.stringify(Array.from(usedPairs)));
        state.base.left = 4095 - usedPairs.size;
        updateBaseLeft();
        return [a,b];
      }
    }
  }
  function resetBase(){ usedPairs=new Set(); localStorage.removeItem('mm_base_used'); state.base.left=4095; updateBaseLeft(); }
  function updateBaseLeft(){ $('#baseLeft').textContent = state.base.left; $('#baseLeftBig').textContent = state.base.left; }

  // ===== Generators =====
  function makeAdd(level){
    let a,b;
    if (level==='easy'){ a=rand(10,99); b=rand(10,99); }
    else if (level==='medium'){ a=rand(100,999); b=rand(10,99); }
    else { a=rand(100,999); b=rand(100,999); }
    return {expr:`${a} + ${b}`, result:a+b, hint:`–†–∞–∑–ª–æ–∂–∏ –Ω–∞ –¥–µ—Å—è—Ç–∫–∏/–µ–¥–∏–Ω–∏—Ü—ã: ${a} + ${b}.`};
  }
  function makeSub(level){
    let a,b;
    if (level==='easy'){ a=rand(10,99); b=rand(10,99); }
    else if (level==='medium'){ a=rand(100,999); b=rand(10,99); }
    else { a=rand(100,999); b=rand(100,999); }
    if (b>a) [a,b]=[b,a];
    return {expr:`${a} ‚àí ${b}`, result:a-b, hint:`–°–Ω–∞—á–∞–ª–∞ –¥–µ—Å—è—Ç–∫–∏, –ø–æ—Ç–æ–º –µ–¥–∏–Ω–∏—Ü—ã.`};
  }
  function mulHint2(a,b){
    const a1=Math.floor(a/10), a2=a%10, b1=Math.floor(b/10), b2=b%10;
    return `${a} √ó ${b} = (${a1}0 + ${a2}) √ó (${b1}0 + ${b2}).`;
  }
  function makeMul(level, thirdMode){
    let a,b,c=null;
    if (state.useBase && level==='easy' && (thirdMode==='off')){
      const pair = pickUnique2x2();
      if (!pair){ state.useBase=false; alert('–ë–∞–∑–∞ 2√ó2 –∏—Å—á–µ—Ä–ø–∞–Ω–∞.'); return makeMul(level, thirdMode); }
      [a,b]=pair;
    } else {
      if (level==='easy'){ a=rand(10,99); b=rand(10,99); }
      else if (level==='medium'){ a=rand(100,999); b=rand(10,99); }
      else { a=rand(100,999); b=rand(100,999); }
    }
    const needThird = (thirdMode==='on') || (thirdMode==='auto' && level==='hard');
    if (needThird){ c = rand(10,99); }
    const expr = c ? `${a} √ó ${b} √ó ${c}` : `${a} √ó ${b}`;
    const result = c ? a*b*c : a*b;
    let hint = mulHint2(a,b);
    if (c) hint += ` –£–º–Ω–æ–∂—å —É–¥–æ–±–Ω—É—é –ø–∞—Ä—É –∏ –¥–æ–º–Ω–æ–∂—å –Ω–∞ ${c}.`;
    return {expr, result, hint};
  }
  function makeDiv(level){
    let divisor, quotient;
    if (level==='easy'){ divisor=rand(2,9); quotient=rand(10,99); }
    else if (level==='medium'){ divisor=rand(10,99); quotient=rand(10,99); }
    else { divisor=rand(10,99); quotient=rand(100,999); }
    const dividend = divisor * quotient;
    return {expr:`${dividend} √∑ ${divisor}`, result:quotient, hint:`–ü–æ–¥–µ–ª–∏ –ø–æ —Ä–∞–∑—Ä—è–¥–∞–º: –ø–æ–ª—É—á–∏—Ç—Å—è ${quotient}.`};
  }
  function makeMixed(level, thirdMode){
    const pool=[];
    if (state.allowedMix.add) pool.push('add');
    if (state.allowedMix.sub) pool.push('sub');
    if (state.allowedMix.mul) pool.push('mul');
    if (state.allowedMix.div) pool.push('div');
    if (pool.length===0) pool.push('add');
    const op = pool[Math.floor(Math.random()*pool.length)];
    if (op==='add') return makeAdd(level);
    if (op==='sub') return makeSub(level);
    if (op==='mul') return makeMul(level, thirdMode);
    return makeDiv(level);
  }
  function makeCustom(){
    const a = Number($('#c-a').value);
    const b = Number($('#c-b').value);
    const c = ($('#c-op2').value==='none') ? null : Number($('#c-c').value);
    const op1 = $('#c-op1').value; const op2 = $('#c-op2').value;
    if (!Number.isFinite(a) || !Number.isFinite(b) || (op2!=='none' && !Number.isFinite(c))) {
      alert('–ó–∞–ø–æ–ª–Ω–∏ —á–∏—Å–ª–∞ –¥–ª—è —Å–≤–æ–µ–π –∑–∞–¥–∞—á–∏'); return null;
    }
    const s = (o)=> o==='*'?'√ó':(o==='/'?'√∑':(o==='-'?'‚àí':'+'));
    const expr = `${a} ${s(op1)} ${b}` + (op2==='none' ? '' : ` ${s(op2)} ${c}`);
    const manual = $('#c-result').value.trim();
    let result;
    if (manual !== '' && Number.isFinite(Number(manual))) {
      result = Number(manual);
    } else {
      const f=(x,o,y)=> o==='*'? x*y : o==='/'? x/y : o==='-'? x-y : x+y;
      result = (op2==='none') ? f(a,op1,b) : f(f(a,op1,b), op2, c);
    }
    return {expr, result, hint:'–†–µ—à–∞–π —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ (–∫–∞–∫ –∑–∞–¥–∞–Ω–æ).'};
  }

  // ===== Session / Timer (elapsed + left) =====
  function setRunning(r){ state.running = r; }
  function renderTimer(left, total){
    const elapsed = total ? total - Math.max(0, left) : (state.running ? Math.floor(performance.now() - state.sessionStart) : 0);
    $('#timeleft').textContent = total ? Math.max(0,Math.ceil(left/1000)) + ' —Å' : '‚Äî';
    $('#bar').style.width = total ? (100 * (1 - left/total)) + '%' : '0%';
    const toMMSS = ms => { const s=Math.max(0,Math.ceil(ms/1000)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return mm+':'+ss; };
    $('#timerDigits').textContent = total ? toMMSS(left) : '00:00';
    $('#elapsedDigits').textContent = toMMSS(elapsed);
  }
  function startSession(){
    const secs = Number($('#timelimit').value)||0;
    state.sessionTotal = secs*1000;
    state.sessionStart = performance.now();
    state.sessionEnd = state.sessionStart + state.sessionTotal;
    if (state.timerId) clearInterval(state.timerId);
    if (secs>0){
      state.timerId = setInterval(()=>{
        const now = performance.now();
        const left = Math.max(0, state.sessionEnd - now);
        renderTimer(left, state.sessionTotal);
        if (left<=0){ stopSession(true); }
      }, 100);
    } else {
      renderTimer(0,0);
    }
    setRunning(true);
  }
  function pauseSession(){
    if (!state.running) return;
    if (state.timerId){
      clearInterval(state.timerId); state.timerId=null; $('#pause').textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    } else {
      const leftText = $('#timeleft').textContent;
      const left = (/\d+/.test(leftText)) ? parseInt(leftText)*1000 : 0;
      state.sessionEnd = performance.now() + left;
      if (state.sessionTotal){
        state.timerId = setInterval(()=>{
          const now = performance.now();
          const l = Math.max(0, state.sessionEnd - now);
          renderTimer(l, state.sessionTotal);
          if (l<=0){ stopSession(true); }
        }, 100);
      }
      $('#pause').textContent='–ü–∞—É–∑–∞';
    }
  }
  function stopSession(timeout=false){
    if (!state.running && !state.timerId) return;
    setRunning(false);
    if (state.timerId) clearInterval(state.timerId); state.timerId=null;
    if (timeout){ $('#feedback').textContent='–í—Ä–µ–º—è –≤—ã—à–ª–æ!'; $('#feedback').className='feedback bad'; }
    $('#task').textContent='–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.';
    renderTimer(state.sessionTotal, state.sessionTotal); // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 00:00 –∏ –∏—Ç–æ–≥ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ
  }

  function newTask(){
    if (!state.running){ $('#feedback').textContent='–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.'; $('#feedback').className='feedback'; return; }
    let pack;
    if (state.mode==='add') pack = makeAdd(state.level);
    else if (state.mode==='sub') pack = makeSub(state.level);
    else if (state.mode==='mul') pack = makeMul(state.level, state.third);
    else if (state.mode==='div') pack = makeDiv(state.level);
    else if (state.mode==='mix') pack = makeMixed(state.level, state.third);
    else pack = makeCustom();
    if (!pack) return;
    state.expr = pack.expr; state.result = pack.result; state.hint = pack.hint;
    $('#task').textContent = pack.expr;
    $('#explain').textContent = pack.hint;
    $('#answer').value=''; $('#feedback').textContent=''; $('#xpgain').textContent='';
    $('#answer').focus();
    state.qStart = performance.now();
  }

  // ===== Stats / History =====
  function updateStats(){
    $('#streak').textContent = state.streak;
    $('#best').textContent = state.best;
    $('#total').textContent = state.total;
    $('#correct').textContent = state.correct;
    const acc = state.total ? Math.round(100 * state.correct / state.total) : 0;
    $('#acc').textContent = acc + '%';
    const avg = state.history.length ? (state.history.reduce((s,h)=>s+h.time,0)/state.history.length) : 0;
    $('#avg').textContent = fmt(avg/1000);
    $('#lastTime').textContent = state.lastTime!=null ? fmt(state.lastTime/1000) : '‚Äî';
  }
  function pushHistory(entry){
    state.history.push(entry);
    localStorage.setItem('mm_history', JSON.stringify(state.history));
    const tbody = $('#table tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${state.history.length}</td><td class="mono">${entry.expr}</td><td>${entry.given}</td><td>${entry.correctVal}</td><td>${entry.ok?'‚úì':'‚úó'}</td><td>${fmt(entry.time/1000)}</td><td class="nowrap">${entry.ts}</td><td>${entry.streak}</td>`;
    tbody.appendChild(tr);
  }
  function rebuildTable(){
    const tbody = $('#table tbody'); tbody.innerHTML='';
    state.history.forEach((h,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td class="mono">${h.expr}</td><td>${h.given}</td><td>${h.correctVal}</td><td>${h.ok?'‚úì':'‚úó'}</td><td>${fmt(h.time/1000)}</td><td class="nowrap">${h.ts}</td><td>${h.streak}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== Check (XP/—Å–µ—Ä–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ running) =====
  function check(){
    if (!state.running){
      $('#feedback').textContent='–°–µ—Å—Å–∏—è –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª.';
      $('#feedback').className='feedback bad';
      return;
    }
    if (state.result==null){ $('#feedback').textContent='–°—Ñ–æ—Ä–º–∏—Ä—É–π –∑–∞–¥–∞—á—É (–∫–Ω–æ–ø–∫–∞ ¬´–°–ª–µ–¥—É—é—â–∞—è¬ª).'; $('#feedback').className='feedback bad'; return; }
    const raw = $('#answer').value.trim();
    if (raw===''){ $('#feedback').textContent='–ü–æ–ª–µ ¬´–û—Ç–≤–µ—Ç¬ª –ø—É—Å—Ç–æ–µ.'; $('#feedback').className='feedback bad'; return; }
    const val = Number(raw);
    if (!Number.isFinite(val)){ $('#feedback').textContent='–í–≤–µ–¥–∏ —á–∏—Å–ª–æ.'; $('#feedback').className='feedback bad'; return; }

    const qTime = performance.now() - state.qStart; state.lastTime = qTime;
    state.total++;
    const ok = (val === state.result);
    if (ok){
      state.correct++; state.streak++;
      state.best = Math.max(state.best, state.streak);
      localStorage.setItem('bestStreak', String(state.best));
      $('#feedback').textContent = '–í–µ—Ä–Ω–æ!'; $('#feedback').className = 'feedback good';
      const gain = 1 * (1 + 0.01 * state.streak);
      state.xp = clamp0(state.xp + gain);
      state.lastGain = gain;
    } else {
      state.streak = 0;
      $('#feedback').textContent = `–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: ${state.result}`; $('#feedback').className = 'feedback bad';
      state.xp = clamp0(state.xp - 2);
      state.lastGain = -2;
    }
    pushHistory({expr:state.expr, given:val, correctVal:state.result, ok, time:qTime, ts:nowISO(), streak:state.streak});
    updateStats();
    updateLevelUI();
  }

  // ===== Events =====
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('[data-mode]').forEach(b=>b.classList.remove('primary'));
      btn.classList.add('primary');
      state.mode = btn.dataset.mode;
      $('#custom-box').style.display = (state.mode==='custom') ? 'block' : 'none';
      $('#mix-ops').style.display = (state.mode==='mix') ? 'block' : 'none';
    });
  });
  $('#level').addEventListener('change', e=> state.level = e.target.value);
  ['m-add','m-sub','m-mul','m-div'].forEach(id=>{
    $('#'+id).addEventListener('change', ()=>{
      state.allowedMix.add = $('#m-add').checked;
      state.allowedMix.sub = $('#m-sub').checked;
      state.allowedMix.mul = $('#m-mul').checked;
      state.allowedMix.div = $('#m-div').checked;
    });
  });
  $('#useBase').addEventListener('click', ()=>{ state.useBase = !state.useBase; $('#useBase').classList.toggle('primary', state.useBase); });
  $('#resetBase').addEventListener('click', ()=>{ if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö 2√ó2?')) resetBase(); });

  $('#c-use').addEventListener('click', ()=>{ if (!state.running) startSession(); newTask(); });

  $('#start').addEventListener('click', ()=>{
    state.streak=0; state.total=0; state.correct=0; updateStats();
    startSession(); newTask();
  });
  $('#pause').addEventListener('click', ()=> pauseSession());
  $('#stop').addEventListener('click', ()=> stopSession(false));
  $('#next').addEventListener('click', ()=> newTask());
  $('#check').addEventListener('click', check);
  $('#clear').addEventListener('click', ()=> $('#answer').value='');
  $('#hint').addEventListener('click', ()=> $('#work').open = true);

  // –•–æ—Ç–∫–µ–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
  function nextHotkey(e){
    if (!state.running) return;
    if ((e.key==='Enter' && (e.ctrlKey||e.metaKey)) || e.code==='Space' || e.key===' '){
      e.preventDefault(); newTask();
    }
  }
  $('#answer').addEventListener('keydown', e=>{
    if (!state.running) return;
    if (e.key==='Enter' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); check(); return; }
    nextHotkey(e);
  });
  document.addEventListener('keydown', e=>{
    if (!state.running) return;
    if (e.key==='Enter' && (e.ctrlKey||e.metaKey)) { e.preventDefault(); newTask(); return; }
    if (e.code==='Space' || e.key===' ') { e.preventDefault(); newTask(); }
  });

  // Export / history
  function toCSV(rows){ return rows.map(r=>[r.expr,r.given,r.correctVal,r.ok?'ok':'wrong',fmt(r.time/1000),r.ts,r.streak].join(',')).join('\n'); }
  $('#exportCsv').addEventListener('click', ()=>{
    const csv = 'expr,given,correct,result,time_s,ts,streak\n' + toCSV(state.history);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'history.csv'; a.click(); URL.revokeObjectURL(url);
  });
  $('#clearHistory').addEventListener('click', ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')){ state.history=[]; localStorage.removeItem('mm_history'); rebuildTable(); updateStats(); }});

  // Initial
  (function init(){
    document.getElementById('mode-mul').classList.add('primary');
    rebuildTable(); updateStats(); updateBaseLeft();
    recalcLevel(); updateLevelUI();
    renderTimer(0,0);
    updateAuthUI();
  })();
</script>
</body>
</html>
